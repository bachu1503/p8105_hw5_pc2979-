---
title: "HW5"
output:   
  github_document
---

### Load packages
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(rvest)
```

## Question 1

Import data by listing out all path names and using `map` to grab observations for each path.
```{r, message = FALSE}
df <-
  tibble(
    files = list.files("data"),
    path = str_c("data/", files)
  ) %>%
  mutate(data = map(path, read_csv)) %>%
  unnest()
```

Clean data
```{r}
tidydf <- 
  df %>% 
  mutate(
    files = str_replace(files, ".csv", ""),
    group = str_sub(files, 1, 3)) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "outcome",
    names_prefix = "week_") %>% 
  mutate(week = as.numeric(week)) %>% 
  select(group, subject = files, week, outcome)
```

Plot data showing observations of each subject over time
```{r}
tidydf %>%
  ggplot(aes(x = week, y = outcome, color = group, group = subject)) +
  geom_point() +
  geom_path() + 
  facet_grid(~group)
```
The graph suggests that outcomes are highly correlated within each group - the outcome of those in the experimental arm are more likely to trend upward over time while the outcome of those in the control arm vary over time. 

## Question 2

Import homicide data from Washington Post github
```{r}
post <- read_csv("https://raw.github.com/washingtonpost/data-homicides/master/homicide-data.csv") %>%
  janitor::clean_names() %>%
  mutate(city_state = paste(city, state, sep =  ", ")) %>%
  select(city_state, everything())
```
There are `r nrow(post)` observations and `r ncol(post)` variables in the `post` dataset. Each row is a single reported homicide by reported date, victim's name, race, and age, reported city and state, latitude and longitude of report, and status of the case. 

A total of `r post %>% select(uid) %>% distinct %>% count` cases across `r post %>% select(state) %>% distinct() %>% count()` states in `r post %>% select(city) %>% distinct() %>% count()` cities are found in the dataset.

```{r}
# summarize_post <-
#   post %>%
#   group_by(city_state, disposition) %>%
#   count(disposition) %>%
#   spread(key = disposition, value = n) %>%
#   janitor::clean_names() %>%
#   mutate(total_hom = sum(closed_by_arrest, closed_without_arrest, open_no_arrest, na.rm = TRUE),
#          n_unsolved = sum(closed_without_arrest, open_no_arrest, na.rm = TRUE),
#          n_solved = closed_by_arrest) %>%
#   select(-c(closed_by_arrest, closed_without_arrest, open_no_arrest))
# 
# summarize_post %>%
#   filter(city_state == "Baltimore, MD") %>%
#   prop.test(x = pull(n_unsolved), n = pull(total_hom), conf.level = 0.95)
# 
# ?prop.test
```

Create functions calculating number of total homicides, number of unsolved homicides, and number of solved homicides for each city. `Map` function into data nested by city.
```{r}
num_hom <- function(df){
  df %>%
    group_by(city) %>%
    summarize(n_homicide = n()) %>%
    select(-city)
}

num_unsolved <- function(df){
  df %>%
    filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>%
    group_by(city) %>%
    summarize(n_unsolved = n()) %>%
    select(-city)
}

num_solved <- function(df){
  df %>%
    filter(disposition == "Closed by arrest") %>%
    group_by(city) %>%
    summarize(n_solved = n()) %>%
    select(-city)
}

post_nest <-
  post %>%
  nest(data = uid:disposition) %>%
  mutate(n_homicide = map(data, num_hom),
         n_unsolved = map(data, num_unsolved),
         n_solved = map(data, num_solved)) %>%
  unnest(c(n_homicide, n_unsolved, n_solved))

```

Use `map2` to estimate proportion of unsolved homicides in Baltimore, MD and pull out relevant information into a tibble.  
```{r}
post_nest %>%
  filter(city_state == "Baltimore, MD") %>%
  mutate(prop_test = map2(n_unsolved, n_homicide, ~prop.test(.x,.y, conf.level = 0.95) %>%
                            broom::tidy())) %>% 
  unnest(prop_test) %>%
  select(city_state, estimate, "CI_lower" = conf.low, "CI_upper" = conf.high) %>%
  knitr::kable(digits = 2)

```


```{r}

```


```{r}

# 
# post_nest %>% 
#   select(-data) %>%
#   prop.test(x = .$n_unsolved, n = .$n_homicide)
# 
# 
#   select(-data) %>%
#   prop.test(x = .$n_unsolved, n = .$n_homicide)
# 
# length(post_nest$n_homicide)
#   
#   prop.test(x = c(.$n_unsolved, .$n_solved), 
#             n = c(rep(.$n_homicide, length(.$n_homicide)),
#                   rep(.$n_homicide, length(.$n_homicide))),
#             conf.level = 0.95)

```


```{r}
# sim_mean_sd = function(n_obs, mu = 7, sigma = 4) {
#   
#   x = rnorm(n = n_obs, mean = mu, sd = sigma)
#   tibble(
#     mu_hat = mean(x),
#     sigma_hat = sd(x)
#   )
#   
# }
```




