---
title: "HW5"
output:   
  github_document
---

### Load packages
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(rvest)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Question 1

Import data by listing out all path names and using `map` to grab observations for each path.
```{r, message = FALSE}
df <-
  tibble(
    files = list.files("data"),
    path = str_c("data/", files)
  ) %>%
  mutate(data = map(path, read_csv)) %>%
  unnest()
```

Clean data
```{r}
tidydf <- 
  df %>% 
  mutate(
    files = str_replace(files, ".csv", ""),
    group = str_sub(files, 1, 3)) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "outcome",
    names_prefix = "week_") %>% 
  mutate(week = as.numeric(week)) %>% 
  select(group, subject = files, week, outcome)
```

Plot data showing observations of each subject over time
```{r}
tidydf %>%
  ggplot(aes(x = week, y = outcome, color = group, group = subject)) +
  geom_point() +
  geom_path() + 
  facet_grid(~group)
```
The graph suggests that outcomes are highly correlated within each group - the outcome of those in the experimental arm are more likely to trend upward over time while the outcome of those in the control arm vary over time. 

## Question 2

Import homicide data from Washington Post github
```{r}
post <- read_csv("https://raw.github.com/washingtonpost/data-homicides/master/homicide-data.csv") %>%
  janitor::clean_names() %>%
  mutate(
    state = case_when(
      city %in% "Tulsa" ~ "OK",
      TRUE ~ state
    ),
    city_state = paste(city, state, sep =  ", ")) %>%
  select(city_state, everything())
```
There are `r nrow(post)` observations and `r ncol(post)` variables in the `post` dataset. Each row is a single reported homicide by reported date, victim's name, race, and age, reported city and state, latitude and longitude of report, and status of the case. 

A total of `r post %>% select(uid) %>% distinct %>% count` cases across `r post %>% select(state) %>% distinct() %>% count()` states in `r post %>% select(city) %>% distinct() %>% count()` cities are found in the dataset.


Create functions calculating number of total homicides, number of unsolved homicides, and number of solved homicides for each city. `Map` function into data nested by city.
```{r}
num_hom <- function(df){
  df %>%
    group_by(city) %>%
    summarize(n_homicide = n()) %>%
    select(-city)
}

num_unsolved <- function(df){
  df %>%
    filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>%
    group_by(city) %>%
    summarize(n_unsolved = n()) %>%
    select(-city)
}

num_solved <- function(df){
  df %>%
    filter(disposition == "Closed by arrest") %>%
    group_by(city) %>%
    summarize(n_solved = n()) %>%
    select(-city)
}

post_nest <-
  post %>%
  nest(data = uid:disposition) %>%
  mutate(n_homicide = map(data, num_hom),
         n_unsolved = map(data, num_unsolved),
         n_solved = map(data, num_solved)) %>%
  unnest(c(n_homicide, n_unsolved, n_solved))

```

Use `map2` to estimate proportion of unsolved homicides in Baltimore, MD and pull out estimate and 95% CI into a tibble.  
```{r}
balti_hom <- 
  post_nest %>%
  filter(city_state == "Baltimore, MD") %>%
  mutate(prop_test = map2(n_unsolved, n_homicide, ~prop.test(.x,.y, conf.level = 0.95) %>%
                            broom::tidy())) %>% 
  unnest(prop_test) %>%
  select(city_state, estimate, "CI_lower" = conf.low, "CI_upper" = conf.high) %>%

balti_hom
```

Use `map2` to estimate proportion of unsolved homicides in all cities and pull  estimate and 95% CI into a tibble.
```{r}
all_hom <-
  post_nest %>%
  mutate(prop_test = map2(n_unsolved, n_homicide, ~prop.test(.x,.y, conf.level = 0.95) %>%
                            broom::tidy())) %>% 
  unnest(prop_test) %>%
  select(city_state, estimate, "ci_lower" = conf.low, "ci_upper" = conf.high)

all_hom
```

Create plot showing proportion and 95% CI of unsolved homicides for each city
```{r}
all_hom %>%
  ggplot(aes(x = reorder(city_state, -estimate), y = estimate)) +
  geom_point(aes(color = city_state)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.5, alpha = 0.7) +
  labs(
    title = "Proportion of Unsolved Homicides Across 50 US Cities",
    x = "City, State",
    y = "Proportion"
  ) +
  theme(text = element_text (size = 6),
        axis.text.x = element_text(angle = 90))
```


## Problem 3



```{r}
n = 30
sigma = 5
mu = 0

sim_norm_sample = function(n = 30, mu, sigma = 5) {
  data = tibble(
    norm_sample = rnorm(n, mean = mu, sd = sigma),
  )
}

t_test = function(x, y){
  t.test(x,
         alternative = c("two.sided"),
         mu = y,
         conf.level = 0.95)
}
```

```{r}
sim_results_df <- 
  expand_grid(
    sample_size = 30,
    mu = 0,
    iteration = 1:5000
  ) %>% 
  mutate(
    norm_sample = map(sample_size, sim_norm_sample),
    mu_est = map(norm_sample, t_test)
  ) %>%
  unnest(mu_est)


    
sim_results_df <- 
  expand_grid(
    sample_size = 30,
    mu = 0,
    iteration = 1:5000
  ) %>% 
  mutate(
    norm_sample = map(sample_size, sim_norm_sample)
  ) %>%
  unnest(norm_sample) %>%
  mutate(
    mu_est =
      map2(norm_sample, mu, ~t.test(x = .x, y = .y))
  )


output = vector("list", length)
for (i in 1:5000){
  output[[i]] = sim_norm_sample(mu = 0)
}

sim_results_df = 
  expand_grid(
    sample_size = c(30, 60, 120, 240),
    true_sigma = c(6, 3),
    iteration = 1:1000
  ) %>% 
  mutate(
    estimate_df = 
      map2(.x = sample_size, .y = true_sigma, ~sim_mean_sd(n_obs = .x, sigma = .y))
  )

data %>%
    summarize(
      mu_hat = mean(x),
      sigma_hat = sd(x)
    )

post_nest <-
  post %>%
  nest(data = uid:disposition) %>%
  mutate(n_homicide = map(data, num_hom),
         n_unsolved = map(data, num_unsolved),
         n_solved = map(data, num_solved)) %>%
  unnest(c(n_homicide, n_unsolved, n_solved))


all_hom <-
  post_nest %>%
  mutate(prop_test = map2(n_unsolved, n_homicide, ~prop.test(.x,.y, conf.level = 0.95) %>%
                            broom::tidy())) %>% 
  unnest(prop_test) %>%
  select(city_state, estimate, "ci_lower" = conf.low, "ci_upper" = conf.high)

?t.test
```

