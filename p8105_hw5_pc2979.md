HW5
================

### Load packages

``` r
library(tidyverse)
library(rvest)
```

## Question 1

Import data by listing out all path names and using `map` to grab
observations for each path.

``` r
df <-
  tibble(
    files = list.files("data"),
    path = str_c("data/", files)
  ) %>%
  mutate(data = map(path, read_csv)) %>%
  unnest()
```

    ## Warning: `cols` is now required when using unnest().
    ## Please use `cols = c(data)`

Clean data

``` r
tidydf <- 
  df %>% 
  mutate(
    files = str_replace(files, ".csv", ""),
    group = str_sub(files, 1, 3)) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "outcome",
    names_prefix = "week_") %>% 
  mutate(week = as.numeric(week)) %>% 
  select(group, subject = files, week, outcome)
```

Plot data showing observations of each subject over time

``` r
tidydf %>%
  ggplot(aes(x = week, y = outcome, color = group, group = subject)) +
  geom_point() +
  geom_path() + 
  facet_grid(~group)
```

![](p8105_hw5_pc2979_files/figure-gfm/unnamed-chunk-4-1.png)<!-- --> The
graph suggests that outcomes are highly correlated within each group -
the outcome of those in the experimental arm are more likely to trend
upward over time while the outcome of those in the control arm vary over
time.

## Question 2

Import homicide data from Washington Post github

``` r
post <- read_csv("https://raw.github.com/washingtonpost/data-homicides/master/homicide-data.csv") %>%
  janitor::clean_names() %>%
  mutate(
    state = case_when(
      city %in% "Tulsa" ~ "OK",
      TRUE ~ state
    ),
    city_state = paste(city, state, sep =  ", ")) %>%
  select(city_state, everything())
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

There are 52179 observations and 13 variables in the `post` dataset.
Each row is a single reported homicide by reported date, victim’s name,
race, and age, reported city and state, latitude and longitude of
report, and status of the case.

A total of 52179 cases across 28 states in 50 cities are found in the
dataset.

Create functions calculating number of total homicides, number of
unsolved homicides, and number of solved homicides for each city. `Map`
function into data nested by city.

``` r
num_hom <- function(df){
  df %>%
    group_by(city) %>%
    summarize(n_homicide = n()) %>%
    select(-city)
}

num_unsolved <- function(df){
  df %>%
    filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>%
    group_by(city) %>%
    summarize(n_unsolved = n()) %>%
    select(-city)
}

num_solved <- function(df){
  df %>%
    filter(disposition == "Closed by arrest") %>%
    group_by(city) %>%
    summarize(n_solved = n()) %>%
    select(-city)
}

post_nest <-
  post %>%
  nest(data = uid:disposition) %>%
  mutate(n_homicide = map(data, num_hom),
         n_unsolved = map(data, num_unsolved),
         n_solved = map(data, num_solved)) %>%
  unnest(c(n_homicide, n_unsolved, n_solved))
```

Use `map2` to estimate proportion of unsolved homicides in Baltimore, MD
and pull out relevant information into a tibble.

``` r
post_nest %>%
  filter(city_state == "Baltimore, MD") %>%
  mutate(prop_test = map2(n_unsolved, n_homicide, ~prop.test(.x,.y, conf.level = 0.95) %>%
                            broom::tidy())) %>% 
  unnest(prop_test) %>%
  select(city_state, estimate, "CI_lower" = conf.low, "CI_upper" = conf.high) %>%
  knitr::kable(digits = 2)
```

| city_state    | estimate | CI_lower | CI_upper |
|:--------------|---------:|---------:|---------:|
| Baltimore, MD |     0.65 |     0.63 |     0.66 |

``` r
post_nest %>%
  mutate(prop_test = map2(n_unsolved, n_homicide, ~prop.test(.x,.y, conf.level = 0.95) %>%
                            broom::tidy())) %>% 
  unnest(prop_test) %>%
  select(city_state, estimate, "CI_lower" = conf.low, "CI_upper" = conf.high) %>%
  knitr::kable(digits = 2)
```

| city_state         | estimate | CI_lower | CI_upper |
|:-------------------|---------:|---------:|---------:|
| Albuquerque, NM    |     0.39 |     0.34 |     0.44 |
| Atlanta, GA        |     0.38 |     0.35 |     0.41 |
| Baltimore, MD      |     0.65 |     0.63 |     0.66 |
| Baton Rouge, LA    |     0.46 |     0.41 |     0.51 |
| Birmingham, AL     |     0.43 |     0.40 |     0.47 |
| Boston, MA         |     0.50 |     0.46 |     0.55 |
| Buffalo, NY        |     0.61 |     0.57 |     0.65 |
| Charlotte, NC      |     0.30 |     0.27 |     0.34 |
| Chicago, IL        |     0.74 |     0.72 |     0.75 |
| Cincinnati, OH     |     0.45 |     0.41 |     0.48 |
| Columbus, OH       |     0.53 |     0.50 |     0.56 |
| Dallas, TX         |     0.48 |     0.46 |     0.51 |
| Denver, CO         |     0.54 |     0.48 |     0.60 |
| Detroit, MI        |     0.59 |     0.57 |     0.61 |
| Durham, NC         |     0.37 |     0.31 |     0.43 |
| Fort Worth, TX     |     0.46 |     0.42 |     0.51 |
| Fresno, CA         |     0.35 |     0.31 |     0.39 |
| Houston, TX        |     0.51 |     0.49 |     0.53 |
| Indianapolis, IN   |     0.45 |     0.42 |     0.48 |
| Jacksonville, FL   |     0.51 |     0.48 |     0.54 |
| Kansas City, MO    |     0.41 |     0.38 |     0.44 |
| Las Vegas, NV      |     0.41 |     0.39 |     0.44 |
| Long Beach, CA     |     0.41 |     0.36 |     0.46 |
| Los Angeles, CA    |     0.49 |     0.47 |     0.51 |
| Louisville, KY     |     0.45 |     0.41 |     0.49 |
| Memphis, TN        |     0.32 |     0.30 |     0.34 |
| Miami, FL          |     0.60 |     0.57 |     0.64 |
| Milwaukee, wI      |     0.36 |     0.33 |     0.39 |
| Minneapolis, MN    |     0.51 |     0.46 |     0.56 |
| Nashville, TN      |     0.36 |     0.33 |     0.40 |
| New Orleans, LA    |     0.65 |     0.62 |     0.67 |
| New York, NY       |     0.39 |     0.35 |     0.43 |
| Oakland, CA        |     0.54 |     0.50 |     0.57 |
| Oklahoma City, OK  |     0.49 |     0.45 |     0.52 |
| Omaha, NE          |     0.41 |     0.37 |     0.46 |
| Philadelphia, PA   |     0.45 |     0.43 |     0.47 |
| Phoenix, AZ        |     0.55 |     0.52 |     0.58 |
| Pittsburgh, PA     |     0.53 |     0.49 |     0.57 |
| Richmond, VA       |     0.26 |     0.22 |     0.31 |
| San Antonio, TX    |     0.43 |     0.39 |     0.46 |
| Sacramento, CA     |     0.37 |     0.32 |     0.42 |
| Savannah, GA       |     0.47 |     0.40 |     0.53 |
| San Bernardino, CA |     0.62 |     0.56 |     0.68 |
| San Diego, CA      |     0.38 |     0.34 |     0.43 |
| San Francisco, CA  |     0.51 |     0.47 |     0.55 |
| St. Louis, MO      |     0.54 |     0.52 |     0.56 |
| Stockton, CA       |     0.60 |     0.55 |     0.64 |
| Tampa, FL          |     0.46 |     0.39 |     0.53 |
| Tulsa, OK          |     0.33 |     0.29 |     0.37 |
| Washington, DC     |     0.44 |     0.41 |     0.46 |

``` r
# 
# post_nest %>% 
#   select(-data) %>%
#   prop.test(x = .$n_unsolved, n = .$n_homicide)
# 
# 
#   select(-data) %>%
#   prop.test(x = .$n_unsolved, n = .$n_homicide)
# 
# length(post_nest$n_homicide)
#   
#   prop.test(x = c(.$n_unsolved, .$n_solved), 
#             n = c(rep(.$n_homicide, length(.$n_homicide)),
#                   rep(.$n_homicide, length(.$n_homicide))),
#             conf.level = 0.95)
```

``` r
# sim_mean_sd = function(n_obs, mu = 7, sigma = 4) {
#   
#   x = rnorm(n = n_obs, mean = mu, sd = sigma)
#   tibble(
#     mu_hat = mean(x),
#     sigma_hat = sd(x)
#   )
#   
# }
```
